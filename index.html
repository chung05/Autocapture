<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åç‰‡æƒæå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS (ç”¨æ–¼å¿«é€Ÿæ¨£å¼è¨­ç½®) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    
    <!-- å…¨åŸŸè¼‰å…¥æ§åˆ¶è…³æœ¬ (é›™æ——æ¨™æ©Ÿåˆ¶) -->
    <script>
        // 1. å®šç¾©å…¨å±€æ——æ¨™
        var Module = {}; 
        var opencvReady = false; // æ——æ¨™ A: OpenCV æ˜¯å¦å®Œæˆæ ¸å¿ƒåˆå§‹åŒ–
        var appLoaded = false;   // æ——æ¨™ B: app.js æ˜¯å¦è¼‰å…¥ä¸¦å®šç¾©äº†æ‰€æœ‰å‡½å¼

        // 2. é›™æ——æ¨™æª¢æŸ¥å‡½å¼ (ä¸è«–å“ªå€‹å…ˆå®Œæˆï¼Œéƒ½å‘¼å«æ­¤å‡½å¼)
        function checkInitialization() {
            var statusDiv = document.getElementById('status');

            if (opencvReady && appLoaded) {
                clearTimeout(opencvLoadTimeout); 
                console.log("DIAG: é›™æ——æ¨™æª¢æŸ¥é€šéã€‚é–‹å§‹æ‡‰ç”¨ç¨‹å¼è‡ªå‹•åˆå§‹åŒ–ã€‚");
                
                // å‘¼å« app.js ä¸­å®šç¾©çš„åˆå§‹åŒ–å‡½å¼
                if (typeof initAppWithOpenCV === 'function') {
                    initAppWithOpenCV();
                } else {
                    statusDiv.innerHTML = 'è‡´å‘½éŒ¯èª¤ï¼šåˆå§‹åŒ–å‡½å¼éºå¤±ã€‚';
                    console.error("DIAG ERROR: initAppWithOpenCV ä»ç„¶æœªå®šç¾©ã€‚");
                }
            } else if (statusDiv && statusDiv.innerHTML === 'OpenCV è¼‰å…¥ä¸­...') {
                // åƒ…æ›´æ–°ç‹€æ…‹ï¼Œä¸åŸ·è¡Œåˆå§‹åŒ–
                statusDiv.innerHTML = 'OpenCV è¼‰å…¥ä¸­...';
            }
        }
        
        // 3. OpenCV å›å‘¼ï¼šè¨­å®šæ——æ¨™ A
        Module.onRuntimeInitialized = function() {
            opencvReady = true;
            console.log("DIAG: OpenCV æ ¸å¿ƒåˆå§‹åŒ–å®Œæˆ (æ——æ¨™ A è¨­ç½®)ã€‚");
            checkInitialization();
        };
        
        // ã€è¼‰å…¥è¨ºæ–·ã€‘è¨­å®šè¶…æ™‚æª¢æŸ¥ (10 ç§’)
        var opencvLoadTimeout = setTimeout(() => {
             var statusDiv = document.getElementById('status');
             if (statusDiv && !opencvReady) { 
                statusDiv.innerHTML = 'éŒ¯èª¤ï¼šOpenCV è¼‰å…¥è¶…æ™‚ (10 ç§’)ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚';
                console.error("DIAG ERROR: OpenCV.js è¼‰å…¥è¶…æ™‚ã€‚");
            }
        }, 10000); 
        
    </script>
    
    <!-- å¾Œè¼‰å…¥ OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js" onerror="document.getElementById('status').innerHTML = 'éŒ¯èª¤ï¼šOpenCV è…³æœ¬è¼‰å…¥å¤±æ•—ï¼ˆç¶²è·¯æˆ–è³‡æºéŒ¯èª¤ï¼‰ã€‚'; console.error('DIAG ERROR: OpenCV.js Script Loading Failed.')"></script>
    
</head>
<body class="bg-gray-900 text-white font-sans flex items-center justify-center p-4">
    <div class="main-container bg-gray-800 p-6 rounded-xl shadow-2xl space-y-4">
        <h1 class="text-3xl font-bold text-center text-blue-400">åç‰‡æƒæèˆ‡æ ¡æ­£</h1>
        
        <!-- ç‹€æ…‹é¡¯ç¤ºå€åŸŸ -->
        <div id="status" class="text-center text-sm p-2 bg-gray-700 rounded-lg text-gray-300 flex-shrink-0">
            OpenCV è¼‰å…¥ä¸­...
        </div>

        <!-- å½±åƒé¡¯ç¤ºå€åŸŸ -->
        <div class="video-canvas-container bg-gray-900 rounded-xl shadow-inner">
            <!-- å¯¦éš›çš„å½±ç‰‡ä¸²æµï¼Œç”¨æ–¼æ“·å–ç•«é¢ä½†éš±è— -->
            <video id="video" playsinline autoplay muted></video>
            
            <!-- é è¦½/è™•ç†ä¸­çš„ Canvas -->
            <canvas id="canvasOutput"></canvas>
            
            <!-- è™•ç†çµæœåœ–ç‰‡é¡¯ç¤ºå€åŸŸ (é è¨­éš±è—) -->
            <div id="snapshotContainer">
                <img id="snapshotImage" alt="æ ¡æ­£å¾Œçš„åç‰‡åœ–ç‰‡" class="mb-4 rounded-lg shadow-xl max-w-full max-h-[80vh]">
                <div class="flex space-x-4 mt-4 flex-shrink-0">
                    <button id="downloadSnapshot" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-150">
                        ä¸‹è¼‰åœ–ç‰‡
                    </button>
                    <button id="retakeButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-150">
                        é‡æ–°æ‹æ”
                    </button>
                </div>
            </div>

            <!-- R3 å°ˆç”¨ï¼šè¶…æ™‚å¾Œé¡¯ç¤ºçš„é‡è©¦æŒ‰éˆ•/è¨Šæ¯ -->
            <div id="timeoutContainer" class="absolute inset-0 bg-black bg-opacity-70 flex-col justify-center items-center rounded-xl hidden">
                 <p class="text-xl font-bold mb-4">ğŸš¨ åµæ¸¬è¶…æ™‚ï¼šè«‹æ”¾å…¥åç‰‡</p>
                 <button id="timeoutRetryButton" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150">
                    é‡å•Ÿæƒæ
                 </button>
            </div>
        </div>
        
        <!-- ç·©è¡ Canvas (é è¨­éš±è—) -->
        <canvas id="canvasBuffer" style="display: none;"></canvas>
    </div>
    
    <!-- è¼‰å…¥ app.js (å®šç¾©æ‰€æœ‰å‡½å¼ï¼Œç„¶å¾Œè¨­å®šæ——æ¨™ B) - ç¢ºä¿åœ¨ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ -->
    <script src="app.js"></script> 
</body>
</html>
